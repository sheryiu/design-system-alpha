<div class="@container/fieldset">
  <div class="core-fieldset" (click)="onTouched?.()" [formGroup]="form">
    @for (fieldDef of fieldDefs; track fieldDef.key) {
      <div class="core-fieldset__label">
        <label [for]="fieldDef.key">{{ fieldDef.label }}</label>
        <!-- TODO toggle fieldType -->
        <!-- <span class="core-fieldset__label__type">{{ fieldDef.fieldType }}</span> -->
      </div>
      <div class="core-fieldset__input">
        <!-- TODO number field will get turned to null when the input is empty -->
        @if (form.controls[fieldDef.key] && form.controls[fieldDef.key].value == null) {
          <div
            class="core-fieldset__input-field"
          >
            <button
              coreHoverable
              coreHardSurface
              color="accent"
              (click)="onSetNotNull(fieldDef)"
              role="button"
              type="button"
              class="core-fieldset__input__add"
            >Add</button>
            <span class="text-secondary px-2 leading-8 select-none">null</span>
          </div>
        } @else {
          @switch (fieldDef.fieldType) {
            @case ('string') {
            <div
              class="core-fieldset__input-field"
            >
              <input
                [id]="fieldDef.key"
                coreInputField
                type="text"
                class="size-full min-h-8 px-2 py-0.5"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
                coreAutocompleteTrigger
                [autocompleteEnabled]="fieldDef.fieldConfig?.enum != null"
                [autocompleteValues]="fieldDef.fieldConfig?.enum"
                [autocompleteTemplateRef]="enumAutocomplete"
                (autocompleteChange)="onAutocomplete(fieldDef, $event)"
              />
            </div>
            }
            @case ('number') {
            <div
              class="core-fieldset__input-field"
            >
              <input
                [id]="fieldDef.key"
                coreInputField
                type="number"
                class="size-full min-h-8 px-2 py-0.5"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
                coreAutocompleteTrigger
                [autocompleteEnabled]="fieldDef.fieldConfig?.enum != null"
                [autocompleteValues]="fieldDef.fieldConfig?.enum"
                [autocompleteTemplateRef]="enumAutocomplete"
                (autocompleteChange)="onAutocomplete(fieldDef, $event)"
              />
            </div>
            }
            @case ('date-time') {
            <div
              class="core-fieldset__input-field"
            >
              <button
                coreHoverable
                coreHardSurface
                color="accent"
                coreCalendarTrigger
                role="button"
                type="button"
                [date]="$any(form.controls[fieldDef.key].value)"
                (dateChange)="onDateChange(fieldDef, $event)"
              >
                <i class="icon-4">calendar_month</i>
              </button>
              <input
                #dateTimeInput
                [id]="fieldDef.key"
                coreInputField
                type="string"
                class="size-full min-h-8 px-2 py-0.5"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
              />
            </div>
            }
            @case ('boolean') {
            <label
              class="core-fieldset__input-field core-fieldset__input-field--boolean"
              [for]="fieldDef.key"
            >
              <input
                [id]="fieldDef.key"
                hidden
                type="checkbox"
                #booleanCheckbox
                [formControlName]="fieldDef.key"
                (input)="handleInput()">
              <button
                coreHoverable
                coreHardSurface
                [color]="booleanCheckbox.checked ? 'primary' : 'gray'"
                coreCalendarTrigger
                role="button"
                type="button"
                (click)="booleanCheckbox.click()"
              >
                <i class="icon-4">drag_indicator</i>
              </button>
              <span>
                {{ booleanCheckbox.checked ? 'On' : 'Off' }}
              </span>
            </label>
            }
            @default {
            <div>Unsupported Type</div>
            }
          }
          <button
            coreHoverable
            type="button"
            role="button"
            (click)="onSetNull(fieldDef)"
            class="core-fieldset__input__remove"
          >
            <i class="icon-4">remove</i>
          </button>
        }
      </div>
    }
  </div>
</div>

<ng-template #enumAutocomplete let-item>
  {{ item }}
</ng-template>