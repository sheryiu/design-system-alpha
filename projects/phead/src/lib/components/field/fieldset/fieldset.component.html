<div class="@container/fieldset">
  <div class="phead-fieldset" (click)="onTouched?.()" [formGroup]="form">
    @for (fieldDef of fieldDefs; track fieldDef.key) {
      <div class="phead-fieldset__label">
        <label [for]="fieldDef.key">{{ fieldDef.label }}</label>
        <!-- TODO toggle fieldType -->
        <!-- <span class="phead-fieldset__label__type">{{ fieldDef.fieldType }}</span> -->
      </div>
      <div class="phead-fieldset__input">
        <!-- TODO number field will get turned to null when the input is empty -->
        @if (form.controls[fieldDef.key] && form.controls[fieldDef.key].value == null) {
          <div
            class="phead-fieldset__input-field phead-fieldset__input-field--null"
          >
            <button
              pheadHoverable
              pheadHardSurface
              color="accent"
              (click)="onSetNotNull(fieldDef)"
              role="button"
              type="button"
              class="phead-fieldset__input__add"
            >Add</button>
            <span>null</span>
          </div>
        } @else {
          @switch (fieldDef.fieldType) {
            @case ('string') {
            <div
              class="phead-fieldset__input-field"
            >
              <input
                [id]="fieldDef.key"
                type="text"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
                pheadAutocompleteTrigger
                [autocompleteEnabled]="fieldDef.fieldConfig?.enum != null"
                [autocompleteValues]="fieldDef.fieldConfig?.enum"
                [autocompleteTemplateRef]="enumAutocomplete"
                (autocompleteChange)="onAutocomplete(fieldDef, $event)"
              />
            </div>
            }
            @case ('number') {
            <div
              class="phead-fieldset__input-field"
            >
              <input
                [id]="fieldDef.key"
                type="number"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
                pheadAutocompleteTrigger
                [autocompleteEnabled]="fieldDef.fieldConfig?.enum != null"
                [autocompleteValues]="fieldDef.fieldConfig?.enum"
                [autocompleteTemplateRef]="enumAutocomplete"
                (autocompleteChange)="onAutocomplete(fieldDef, $event)"
              />
            </div>
            }
            @case ('date-time') {
            <div
              class="phead-fieldset__input-field"
            >
              <button
                pheadHoverable
                pheadHardSurface
                color="accent"
                pheadCalendarTrigger
                role="button"
                type="button"
                [date]="$any(form.controls[fieldDef.key].value)"
                (dateChange)="onDateChange(fieldDef, $event)"
              >
                <i>calendar_month</i>
              </button>
              <input
                #dateTimeInput
                [id]="fieldDef.key"
                type="text"
                [formControlName]="fieldDef.key"
                (input)="handleInput()"
              />
            </div>
            }
            @case ('boolean') {
            <label
              class="phead-fieldset__input-field phead-fieldset__input-field--boolean"
              [for]="fieldDef.key"
            >
              <input
                [id]="fieldDef.key"
                hidden
                type="checkbox"
                #booleanCheckbox
                [formControlName]="fieldDef.key"
                (input)="handleInput()">
              <button
                pheadHoverable
                pheadHardSurface
                [color]="booleanCheckbox.checked ? 'primary' : 'gray'"
                role="button"
                type="button"
                (click)="booleanCheckbox.click()"
              >
                <i>drag_indicator</i>
              </button>
              <span>
                {{ booleanCheckbox.checked ? 'On' : 'Off' }}
              </span>
            </label>
            }
            @default {
            <div>Unsupported Type</div>
            }
          }
          <button
            pheadHoverable
            type="button"
            role="button"
            (click)="onSetNull(fieldDef)"
            class="phead-fieldset__input__remove"
          >
            <i>remove</i>
          </button>
        }
      </div>
    }
  </div>
</div>

<ng-template #enumAutocomplete let-item>
  {{ item }}
</ng-template>